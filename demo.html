<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>@motioneffector/llm - Demo</title>
  <style>
/* ============================================
   RESET & BASE
   ============================================ */

*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
  font-size: 1rem;
  line-height: 1.5;
  color: #e6edf3;
  background: #0d1117;
  min-height: 100vh;
}

/* ============================================
   CSS VARIABLES
   ============================================ */

:root {
  /* Backgrounds */
  --bg-primary: #0d1117;
  --bg-secondary: #161b22;
  --bg-tertiary: #21262d;
  --bg-hover: #30363d;

  /* Borders */
  --border-default: #30363d;
  --border-muted: #21262d;

  /* Text */
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --text-link: #58a6ff;

  /* Accents */
  --accent-blue: #1f6feb;
  --accent-blue-hover: #388bfd;
  --accent-green: #238636;
  --accent-green-bright: #3fb950;
  --accent-red: #da3633;
  --accent-red-bright: #f85149;
  --accent-yellow: #d29922;
  --accent-yellow-bright: #e3b341;
  --accent-purple: #8957e5;

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-xxl: 48px;

  /* Radii */
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 8px;
  --radius-xl: 12px;

  /* Typography */
  --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
  --font-size-xs: 0.75rem;
  --font-size-sm: 0.875rem;
  --font-size-md: 1rem;
  --font-size-lg: 1.25rem;
  --font-size-xl: 1.5rem;
  --font-size-xxl: 2rem;

  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);

  /* Transitions */
  --transition-fast: 0.1s ease;
  --transition-normal: 0.2s ease;
  --transition-slow: 0.3s ease;
}

/* ============================================
   LAYOUT
   ============================================ */

.page {
  max-width: 1200px;
  margin: 0 auto;
  padding: var(--space-xl);
}

/* ============================================
   HEADER
   ============================================ */

.header {
  margin-bottom: var(--space-xxl);
  padding-bottom: var(--space-xl);
  border-bottom: 1px solid var(--border-default);
}

.header-title {
  font-size: var(--font-size-xxl);
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-sm);
}

.header-description {
  font-size: var(--font-size-lg);
  color: var(--text-secondary);
  margin-bottom: var(--space-lg);
}

.header-links {
  display: flex;
  gap: var(--space-md);
}

.header-link {
  display: inline-flex;
  align-items: center;
  gap: var(--space-xs);
  color: var(--text-link);
  text-decoration: none;
  font-size: var(--font-size-sm);
  padding: var(--space-xs) var(--space-sm);
  border-radius: var(--radius-md);
  transition: background var(--transition-fast);
}

.header-link:hover {
  background: var(--bg-tertiary);
  text-decoration: underline;
}

/* ============================================
   EXHIBITS
   ============================================ */

.exhibits {
  display: flex;
  flex-direction: column;
  gap: var(--space-xxl);
}

.exhibit {
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-xl);
  overflow: hidden;
}

.exhibit-header {
  padding: var(--space-lg);
  border-bottom: 1px solid var(--border-default);
}

.exhibit-title {
  font-size: var(--font-size-xl);
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-xs);
}

.exhibit-description {
  font-size: var(--font-size-md);
  color: var(--text-secondary);
}

.exhibit-content {
  padding: var(--space-lg);
}

.exhibit-interactive {
  background: var(--bg-primary);
  border: 1px solid var(--border-muted);
  border-radius: var(--radius-lg);
  min-height: 200px;
  padding: var(--space-lg);
  margin-bottom: var(--space-lg);
}

.exhibit-controls {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-sm);
  padding: var(--space-md);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-lg);
  align-items: center;
}

.exhibit-state {
  padding: var(--space-md);
  background: var(--bg-primary);
  border: 1px solid var(--border-muted);
  border-radius: var(--radius-md);
  font-family: var(--font-mono);
  font-size: var(--font-size-sm);
}

.exhibit-state-title {
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--space-sm);
}

/* ============================================
   BUTTONS
   ============================================ */

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-xs);
  padding: var(--space-sm) var(--space-md);
  font-size: var(--font-size-sm);
  font-weight: 500;
  border-radius: var(--radius-md);
  border: 1px solid transparent;
  cursor: pointer;
  transition: all var(--transition-fast);
  white-space: nowrap;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--accent-blue);
  color: white;
  border-color: var(--accent-blue);
}

.btn-primary:hover:not(:disabled) {
  background: var(--accent-blue-hover);
  border-color: var(--accent-blue-hover);
}

.btn-secondary {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-color: var(--border-default);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--bg-hover);
}

.btn-danger {
  background: var(--accent-red);
  color: white;
  border-color: var(--accent-red);
}

.btn-danger:hover:not(:disabled) {
  background: var(--accent-red-bright);
}

.btn-success {
  background: var(--accent-green);
  color: white;
  border-color: var(--accent-green);
}

.btn-success:hover:not(:disabled) {
  background: var(--accent-green-bright);
}

.btn-small {
  padding: var(--space-xs) var(--space-sm);
  font-size: var(--font-size-xs);
}

/* ============================================
   INPUTS
   ============================================ */

.input {
  background: var(--bg-primary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  padding: var(--space-sm) var(--space-md);
  font-size: var(--font-size-sm);
  color: var(--text-primary);
  transition: border-color var(--transition-fast);
}

.input:focus {
  outline: none;
  border-color: var(--accent-blue);
}

.input::placeholder {
  color: var(--text-muted);
}

.input-mono {
  font-family: var(--font-mono);
}

select.input {
  cursor: pointer;
}

textarea.input {
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
}

/* ============================================
   TOGGLE
   ============================================ */

.toggle {
  display: inline-flex;
  align-items: center;
  gap: var(--space-sm);
  cursor: pointer;
  font-size: var(--font-size-sm);
}

.toggle-switch {
  position: relative;
  width: 40px;
  height: 22px;
  background: var(--bg-hover);
  border-radius: 11px;
  transition: background var(--transition-normal);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 16px;
  height: 16px;
  background: var(--text-primary);
  border-radius: 50%;
  transition: transform var(--transition-normal);
}

.toggle input {
  display: none;
}

.toggle input:checked + .toggle-switch {
  background: var(--accent-blue);
}

.toggle input:checked + .toggle-switch::after {
  transform: translateX(18px);
}

.toggle-label {
  color: var(--text-secondary);
}

/* ============================================
   TAGS / BADGES
   ============================================ */

.tag {
  display: inline-block;
  padding: var(--space-xs) var(--space-sm);
  font-size: var(--font-size-xs);
  font-weight: 500;
  border-radius: var(--radius-sm);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.tag-blue {
  background: rgba(31, 111, 235, 0.2);
  color: var(--accent-blue-hover);
}

.tag-green {
  background: rgba(35, 134, 54, 0.2);
  color: var(--accent-green-bright);
}

.tag-red {
  background: rgba(218, 54, 51, 0.2);
  color: var(--accent-red-bright);
}

.tag-yellow {
  background: rgba(210, 153, 34, 0.2);
  color: var(--accent-yellow-bright);
}

.tag-purple {
  background: rgba(137, 87, 229, 0.2);
  color: var(--accent-purple);
}

/* ============================================
   TEST RUNNER
   ============================================ */

.test-runner {
  margin-top: var(--space-xxl);
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-xl);
  overflow: hidden;
}

.test-runner-header {
  padding: var(--space-lg);
  border-bottom: 1px solid var(--border-default);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.test-runner-title {
  font-size: var(--font-size-xl);
  font-weight: 600;
}

.test-runner-actions {
  display: flex;
  gap: var(--space-sm);
}

.test-runner-content {
  padding: var(--space-lg);
}

.test-progress {
  margin-bottom: var(--space-lg);
}

.test-progress-bar {
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: var(--space-sm);
}

.test-progress-fill {
  height: 100%;
  background: var(--accent-blue);
  border-radius: 4px;
  transition: width var(--transition-fast);
  width: 0%;
}

.test-progress-fill.success {
  background: var(--accent-green);
}

.test-progress-fill.failure {
  background: var(--accent-red);
}

.test-progress-text {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

.test-output {
  background: var(--bg-primary);
  border: 1px solid var(--border-muted);
  border-radius: var(--radius-md);
  max-height: 400px;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: var(--font-size-sm);
}

.test-output-empty {
  padding: var(--space-xl);
  text-align: center;
  color: var(--text-muted);
}

.test-item {
  padding: var(--space-sm) var(--space-md);
  border-bottom: 1px solid var(--border-muted);
  display: flex;
  align-items: flex-start;
  gap: var(--space-sm);
}

.test-item:last-child {
  border-bottom: none;
}

.test-icon {
  flex-shrink: 0;
  font-size: var(--font-size-md);
}

.test-icon.pass {
  color: var(--accent-green-bright);
}

.test-icon.fail {
  color: var(--accent-red-bright);
}

.test-name {
  color: var(--text-primary);
}

.test-error {
  color: var(--accent-red-bright);
  font-size: var(--font-size-xs);
  margin-top: var(--space-xs);
}

.test-summary {
  margin-top: var(--space-lg);
  padding: var(--space-md);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  font-size: var(--font-size-sm);
  display: flex;
  gap: var(--space-lg);
}

.test-summary-item {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
}

.test-summary-item.passed {
  color: var(--accent-green-bright);
}

.test-summary-item.failed {
  color: var(--accent-red-bright);
}

.test-summary-item.skipped {
  color: var(--text-muted);
}

/* ============================================
   UTILITY CLASSES
   ============================================ */

.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--accent-green-bright); }
.text-error { color: var(--accent-red-bright); }
.text-warning { color: var(--accent-yellow-bright); }

.font-mono { font-family: var(--font-mono); }

.flex { display: flex; }
.flex-col { flex-direction: column; }
.flex-wrap { flex-wrap: wrap; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-xs { gap: var(--space-xs); }
.gap-sm { gap: var(--space-sm); }
.gap-md { gap: var(--space-md); }
.gap-lg { gap: var(--space-lg); }

.mt-sm { margin-top: var(--space-sm); }
.mt-md { margin-top: var(--space-md); }
.mt-lg { margin-top: var(--space-lg); }
.mb-sm { margin-bottom: var(--space-sm); }
.mb-md { margin-bottom: var(--space-md); }
.mb-lg { margin-bottom: var(--space-lg); }

.p-sm { padding: var(--space-sm); }
.p-md { padding: var(--space-md); }
.p-lg { padding: var(--space-lg); }

.hidden { display: none; }

/* ============================================
   SCROLLBAR
   ============================================ */

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
  background: var(--bg-hover);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-default);
}

/* ============================================
   EXHIBIT-SPECIFIC STYLES
   ============================================ */

/* Stream Decoder */
.stream-panels {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: var(--space-md);
  min-height: 300px;
}

.stream-panel {
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.stream-panel-title {
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--space-sm);
  padding-bottom: var(--space-sm);
  border-bottom: 1px solid var(--border-muted);
}

.stream-panel-content {
  flex: 1;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: var(--font-size-xs);
}

.sse-line {
  padding: var(--space-xs);
  border-radius: var(--radius-sm);
  margin-bottom: var(--space-xs);
  word-break: break-all;
  transition: background var(--transition-fast);
}

.sse-line.highlight {
  background: rgba(31, 111, 235, 0.3);
}

.sse-line .sse-key {
  color: var(--accent-purple);
}

.sse-line .sse-value {
  color: var(--accent-green-bright);
}

.chunk-chip {
  display: inline-block;
  padding: var(--space-xs) var(--space-sm);
  background: var(--bg-hover);
  border-radius: var(--radius-sm);
  margin: var(--space-xs);
  animation: chipIn 0.2s ease;
}

@keyframes chipIn {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

.output-text {
  font-size: var(--font-size-sm);
  line-height: 1.6;
  white-space: pre-wrap;
}

.cursor {
  display: inline-block;
  width: 2px;
  height: 1em;
  background: var(--text-primary);
  animation: blink 1s infinite;
  vertical-align: text-bottom;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

/* Resilience Lab */
.timeline-container {
  padding: var(--space-lg) 0;
}

.timeline {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-xl) 0;
}

.timeline::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--border-default);
  transform: translateY(-50%);
}

.timeline-node {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-sm);
}

.timeline-dot {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-default);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-size-xs);
  transition: all var(--transition-normal);
}

.timeline-dot.pending { background: var(--bg-tertiary); }
.timeline-dot.active { background: var(--accent-yellow); border-color: var(--accent-yellow); }
.timeline-dot.success { background: var(--accent-green); border-color: var(--accent-green); }
.timeline-dot.error { background: var(--accent-red); border-color: var(--accent-red); }
.timeline-dot.waiting { background: var(--accent-yellow); border-color: var(--accent-yellow); }

.timeline-label {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
  text-align: center;
  max-width: 80px;
}

.timeline-time {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.event-log {
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  max-height: 200px;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: var(--font-size-xs);
  margin-top: var(--space-lg);
}

.event-log-entry {
  padding: var(--space-xs) 0;
  display: flex;
  gap: var(--space-sm);
  align-items: flex-start;
}

.event-log-entry .icon { flex-shrink: 0; }
.event-log-entry .time { color: var(--text-muted); flex-shrink: 0; }
.event-log-entry .message { color: var(--text-primary); }
.event-log-entry.error .message { color: var(--accent-red-bright); }
.event-log-entry.success .message { color: var(--accent-green-bright); }
.event-log-entry.waiting .message { color: var(--accent-yellow-bright); }

/* Conversation State Machine */
.conversation-split {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-lg);
  min-height: 400px;
}

.conversation-panel {
  display: flex;
  flex-direction: column;
}

.conversation-panel-title {
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--space-sm);
}

.messages-container {
  flex: 1;
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  overflow-y: auto;
  margin-bottom: var(--space-md);
}

.message {
  padding: var(--space-sm) var(--space-md);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-sm);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.message:hover {
  transform: translateX(4px);
}

.message.selected {
  outline: 2px solid var(--accent-blue);
}

.message.system {
  background: rgba(137, 87, 229, 0.2);
  border-left: 3px solid var(--accent-purple);
}

.message.user {
  background: rgba(31, 111, 235, 0.2);
  border-left: 3px solid var(--accent-blue);
}

.message.assistant {
  background: rgba(35, 134, 54, 0.2);
  border-left: 3px solid var(--accent-green);
}

.message-role {
  font-size: var(--font-size-xs);
  font-weight: 600;
  text-transform: uppercase;
  margin-bottom: var(--space-xs);
}

.message.system .message-role { color: var(--accent-purple); }
.message.user .message-role { color: var(--accent-blue-hover); }
.message.assistant .message-role { color: var(--accent-green-bright); }

.message-content {
  font-size: var(--font-size-sm);
  color: var(--text-primary);
  white-space: pre-wrap;
}

.message-input-area {
  display: flex;
  gap: var(--space-sm);
}

.message-input-area input {
  flex: 1;
}

.json-inspector {
  flex: 1;
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: var(--font-size-xs);
}

.json-inspector pre {
  white-space: pre-wrap;
  word-break: break-all;
}

.json-key { color: var(--accent-purple); }
.json-string { color: var(--accent-green-bright); }
.json-number { color: var(--accent-yellow-bright); }
.json-bracket { color: var(--text-muted); }
.json-highlight { background: rgba(31, 111, 235, 0.3); }

.context-bar-container {
  margin-top: var(--space-md);
}

.context-bar {
  height: 8px;
  background: var(--bg-hover);
  border-radius: 4px;
  overflow: hidden;
  margin-top: var(--space-xs);
}

.context-bar-fill {
  height: 100%;
  background: var(--accent-blue);
  transition: width var(--transition-normal);
}

/* Token Visualizer */
.token-input-area {
  margin-bottom: var(--space-lg);
}

.token-input-area textarea {
  width: 100%;
  min-height: 100px;
}

.token-blocks {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-xs);
  margin-bottom: var(--space-lg);
  min-height: 60px;
  padding: var(--space-md);
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
}

.token-block {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  padding: var(--space-xs) var(--space-sm);
  background: var(--bg-hover);
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: var(--font-size-xs);
  animation: tokenIn 0.15s ease;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.token-block:hover {
  background: var(--accent-blue);
}

@keyframes tokenIn {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

.token-block-text {
  color: var(--text-primary);
  max-width: 60px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.token-block-num {
  color: var(--text-muted);
  font-size: 10px;
}

.token-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: var(--space-md);
  margin-bottom: var(--space-lg);
}

.token-stat {
  background: var(--bg-tertiary);
  padding: var(--space-md);
  border-radius: var(--radius-md);
}

.token-stat-label {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
  text-transform: uppercase;
}

.token-stat-value {
  font-size: var(--font-size-xl);
  font-weight: 600;
  color: var(--text-primary);
  font-family: var(--font-mono);
}

.model-table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--font-size-sm);
}

.model-table th,
.model-table td {
  padding: var(--space-sm) var(--space-md);
  text-align: left;
  border-bottom: 1px solid var(--border-muted);
}

.model-table th {
  color: var(--text-muted);
  font-weight: 500;
  font-size: var(--font-size-xs);
  text-transform: uppercase;
}

.model-table tr {
  cursor: pointer;
  transition: background var(--transition-fast);
}

.model-table tr:hover {
  background: var(--bg-tertiary);
}

.model-table tr.selected {
  background: rgba(31, 111, 235, 0.2);
}

.model-table tr.selected td {
  color: var(--text-primary);
}

/* Slider */
.slider-container {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.slider-container input[type="range"] {
  width: 120px;
  accent-color: var(--accent-blue);
}

.slider-value {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
  font-family: var(--font-mono);
  min-width: 50px;
}

/* Scenario buttons */
.scenario-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-sm);
}

.scenario-btn {
  padding: var(--space-sm) var(--space-md);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.scenario-btn:hover {
  background: var(--bg-hover);
}

.scenario-btn.active {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
}

/* Simulated badge */
.simulated-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--space-xs);
  padding: var(--space-xs) var(--space-sm);
  background: rgba(210, 153, 34, 0.2);
  color: var(--accent-yellow-bright);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  font-weight: 500;
}

@media (max-width: 768px) {
  .stream-panels {
    grid-template-columns: 1fr;
  }

  .conversation-split {
    grid-template-columns: 1fr;
  }

  .timeline {
    flex-direction: column;
    gap: var(--space-lg);
  }

  .timeline::before {
    top: 0;
    bottom: 0;
    left: 50%;
    width: 2px;
    height: auto;
    transform: translateX(-50%);
  }
}
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <h1 class="header-title">@motioneffector/llm</h1>
      <p class="header-description">TypeScript client for LLM APIs with streaming, conversations, and automatic retries</p>
      <nav class="header-links">
        <a href="https://www.npmjs.com/package/@motioneffector/llm" class="header-link" target="_blank">
          üì¶ npm
        </a>
        <a href="https://github.com/motioneffector/llm" class="header-link" target="_blank">
          üíª GitHub
        </a>
        <a href="https://github.com/motioneffector/llm/wiki" class="header-link" target="_blank">
          üìñ Manual
        </a>
        <span class="simulated-badge">üî∂ SIMULATED</span>
      </nav>
    </header>

    <main class="exhibits">
      <!-- Exhibit 1: Stream Decoder -->
      <section class="exhibit">
        <div class="exhibit-header">
          <h2 class="exhibit-title">Stream Decoder</h2>
          <p class="exhibit-description">Watch how streaming actually works - SSE events arrive, get parsed, and assemble into readable text</p>
        </div>
        <div class="exhibit-content">
          <div class="exhibit-interactive">
            <div class="stream-panels">
              <div class="stream-panel">
                <div class="stream-panel-title">Raw SSE Stream</div>
                <div class="stream-panel-content" id="sse-raw"></div>
              </div>
              <div class="stream-panel">
                <div class="stream-panel-title">Parsed Chunks</div>
                <div class="stream-panel-content" id="sse-chunks"></div>
              </div>
              <div class="stream-panel">
                <div class="stream-panel-title">Assembled Output</div>
                <div class="stream-panel-content">
                  <div class="output-text" id="sse-output"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="exhibit-controls">
            <select class="input" id="stream-preset">
              <option value="short">Short response</option>
              <option value="code">Code example</option>
              <option value="long">Long response</option>
              <option value="emoji">Emoji content</option>
            </select>
            <button class="btn btn-primary" id="stream-run">‚ñ∂ Run</button>
            <button class="btn btn-secondary" id="stream-pause">‚è∏ Pause</button>
            <button class="btn btn-secondary" id="stream-replay">‚Üª Replay</button>
            <div class="slider-container">
              <span class="text-secondary">Speed:</span>
              <input type="range" id="stream-speed" min="10" max="500" value="100">
              <span class="slider-value" id="stream-speed-value">100ms</span>
            </div>
          </div>
          <div class="exhibit-state">
            <div class="exhibit-state-title">State</div>
            <div class="flex gap-lg">
              <div><span class="text-muted">Chunks:</span> <span id="stream-chunk-count">0</span></div>
              <div><span class="text-muted">Bytes:</span> <span id="stream-bytes">0</span></div>
              <div><span class="text-muted">Status:</span> <span id="stream-status" class="tag">Ready</span></div>
              <div><span class="text-muted">Time:</span> <span id="stream-time">0.00s</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Exhibit 2: Resilience Lab -->
      <section class="exhibit">
        <div class="exhibit-header">
          <h2 class="exhibit-title">Resilience Lab</h2>
          <p class="exhibit-description">See retry logic in action - exponential backoff, jitter, and error handling made visible</p>
        </div>
        <div class="exhibit-content">
          <div class="exhibit-interactive">
            <div class="timeline-container">
              <div class="timeline" id="resilience-timeline">
                <!-- Timeline nodes rendered by JS -->
              </div>
              <div class="event-log" id="resilience-log">
                <!-- Event log entries rendered by JS -->
              </div>
            </div>
          </div>
          <div class="exhibit-controls">
            <div class="scenario-buttons">
              <button class="scenario-btn active" data-scenario="success">Clean Success</button>
              <button class="scenario-btn" data-scenario="rate-limit">Rate Limit (429)</button>
              <button class="scenario-btn" data-scenario="server-error">Server Error (503)</button>
              <button class="scenario-btn" data-scenario="timeout">Network Timeout</button>
              <button class="scenario-btn" data-scenario="auth">Auth Failure (401)</button>
              <button class="scenario-btn" data-scenario="max-retries">Max Retries</button>
            </div>
            <button class="btn btn-danger" id="resilience-abort" disabled>Abort</button>
            <label class="toggle">
              <input type="checkbox" id="resilience-accelerated" checked>
              <span class="toggle-switch"></span>
              <span class="toggle-label">10x Speed</span>
            </label>
          </div>
          <div class="exhibit-state">
            <div class="exhibit-state-title">State</div>
            <div class="flex gap-lg">
              <div><span class="text-muted">Attempt:</span> <span id="resilience-attempt">-</span></div>
              <div><span class="text-muted">Next retry:</span> <span id="resilience-countdown">-</span></div>
              <div><span class="text-muted">Elapsed:</span> <span id="resilience-elapsed">0.00s</span></div>
              <div><span class="text-muted">Retriable:</span> <span id="resilience-retriable">-</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Exhibit 3: Conversation State Machine -->
      <section class="exhibit">
        <div class="exhibit-header">
          <h2 class="exhibit-title">Conversation State Machine</h2>
          <p class="exhibit-description">See the actual data structures being built - watch the messages array grow in real-time</p>
        </div>
        <div class="exhibit-content">
          <div class="exhibit-interactive">
            <div class="conversation-split">
              <div class="conversation-panel">
                <div class="conversation-panel-title">Conversation</div>
                <div class="messages-container" id="conv-messages">
                  <!-- Messages rendered by JS -->
                </div>
                <div class="message-input-area">
                  <input type="text" class="input" id="conv-input" placeholder="Type a message...">
                  <button class="btn btn-primary" id="conv-send">Send</button>
                </div>
              </div>
              <div class="conversation-panel">
                <div class="conversation-panel-title">State Inspector</div>
                <div class="json-inspector" id="conv-json">
                  <pre></pre>
                </div>
                <div class="context-bar-container">
                  <div class="flex justify-between">
                    <span class="text-muted text-xs">Token usage</span>
                    <span class="text-muted text-xs" id="conv-token-count">0 / 200,000</span>
                  </div>
                  <div class="context-bar">
                    <div class="context-bar-fill" id="conv-context-fill" style="width: 0%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="exhibit-controls">
            <select class="input" id="conv-preset">
              <option value="coding">Coding Q&A</option>
              <option value="creative">Creative Writing</option>
              <option value="long">Long Context</option>
              <option value="empty">Empty Slate</option>
            </select>
            <button class="btn btn-secondary" id="conv-load-preset">Load Preset</button>
            <button class="btn btn-secondary" id="conv-clear">Clear</button>
            <button class="btn btn-danger" id="conv-clear-all">Clear All</button>
          </div>
        </div>
      </section>

      <!-- Exhibit 4: Token Visualizer -->
      <section class="exhibit">
        <div class="exhibit-header">
          <h2 class="exhibit-title">Token Visualizer</h2>
          <p class="exhibit-description">See how token estimation works - watch text get chunked into ~4-character blocks</p>
        </div>
        <div class="exhibit-content">
          <div class="exhibit-interactive">
            <div class="token-input-area">
              <textarea class="input" id="token-input" placeholder="Type or paste text...">The quick brown fox jumps over the lazy dog. This classic pangram contains every letter of the English alphabet at least once, making it perfect for testing fonts and keyboards.</textarea>
            </div>
            <div class="token-blocks" id="token-blocks">
              <!-- Token blocks rendered by JS -->
            </div>
            <div class="token-stats">
              <div class="token-stat">
                <div class="token-stat-label">Characters</div>
                <div class="token-stat-value" id="token-chars">0</div>
              </div>
              <div class="token-stat">
                <div class="token-stat-label">Estimated Tokens</div>
                <div class="token-stat-value" id="token-count">0</div>
              </div>
              <div class="token-stat">
                <div class="token-stat-label">Est. Prompt Cost</div>
                <div class="token-stat-value" id="token-cost">$0.00</div>
              </div>
            </div>
            <table class="model-table" id="model-table">
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Context</th>
                  <th>$/M Prompt</th>
                  <th>$/M Completion</th>
                </tr>
              </thead>
              <tbody>
                <!-- Model rows rendered by JS -->
              </tbody>
            </table>
          </div>
          <div class="exhibit-controls">
            <select class="input" id="token-preset">
              <option value="pangram">Pangram</option>
              <option value="code">Code Snippet</option>
              <option value="long">Long Text</option>
              <option value="minimal">Minimal</option>
              <option value="unicode">Unicode</option>
            </select>
            <button class="btn btn-secondary" id="token-load-preset">Load Preset</button>
            <button class="btn btn-secondary" id="token-reset">Reset</button>
          </div>
        </div>
      </section>
    </main>

    <footer class="test-runner">
      <div class="test-runner-header">
        <h2 class="test-runner-title">Test Suite</h2>
        <div class="test-runner-actions">
          <button class="btn btn-primary" id="run-tests">Run Tests</button>
          <button class="btn btn-secondary" id="run-fuzz" style="display: none;">Run Fuzz Tests</button>
        </div>
      </div>
      <div class="test-runner-content">
        <div class="test-progress">
          <div class="test-progress-bar">
            <div class="test-progress-fill" id="progress-fill"></div>
          </div>
          <div class="test-progress-text" id="progress-text">Ready to run tests</div>
        </div>
        <div class="test-output" id="test-output">
          <div class="test-output-empty">Click "Run Tests" to execute the test suite</div>
        </div>
        <div class="test-summary hidden" id="test-summary">
          <div class="test-summary-item passed">
            <span>‚úì</span>
            <span id="passed-count">0</span> passed
          </div>
          <div class="test-summary-item failed">
            <span>‚úó</span>
            <span id="failed-count">0</span> failed
          </div>
          <div class="test-summary-item skipped">
            <span>‚óã</span>
            <span id="skipped-count">0</span> skipped
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script type="module">
// ============================================
// SIMULATED DATA
// ============================================

const PRESETS = {
  stream: {
    short: {
      prompt: "Explain how a car engine works in 2 sentences.",
      response: "A car engine works by igniting a mixture of fuel and air inside cylinders, which pushes pistons up and down to create rotational force. This force is transferred through the transmission to the wheels, propelling the vehicle forward."
    },
    code: {
      prompt: "Write a Python function to reverse a string",
      response: `def reverse_string(s):
    """Reverse a string using slicing."""
    return s[::-1]

# Example usage
text = "Hello, World!"
print(reverse_string(text))  # Output: !dlroW ,olleH`
    },
    long: {
      prompt: "List 5 interesting facts about octopuses",
      response: `Here are 5 fascinating facts about octopuses:

1. **Three Hearts**: Octopuses have three hearts - two pump blood to the gills, while the third pumps it to the rest of the body.

2. **Blue Blood**: Their blood is copper-based (hemocyanin) rather than iron-based, making it blue and more efficient at transporting oxygen in cold, low-oxygen environments.

3. **Master of Disguise**: They can change both color and texture in milliseconds, thanks to specialized cells called chromatophores, allowing them to blend perfectly with their surroundings.

4. **Distributed Intelligence**: About two-thirds of their neurons are located in their arms, meaning each arm can taste, touch, and even make decisions semi-independently.

5. **Short Lifespan**: Despite their intelligence, most octopuses live only 1-2 years. Females often die shortly after their eggs hatch, having stopped eating to guard them.`
    },
    emoji: {
      prompt: "Describe the seasons using only emojis",
      response: "üå∏üå∑üê£üåà‚òî ‚Üí ‚òÄÔ∏èüèñÔ∏èüåäüç¶üï∂Ô∏è ‚Üí üçÇüéÉüçÅüå∞ü¶É ‚Üí ‚ùÑÔ∏è‚õÑüéÑüß£‚òï"
    }
  },
  conversation: {
    coding: {
      system: "You are a helpful coding assistant. Be concise.",
      messages: [
        { role: "user", content: "What's the difference between let and const in JavaScript?" },
        { role: "assistant", content: "let allows reassignment, const doesn't. Both are block-scoped, unlike var which is function-scoped." },
        { role: "user", content: "Show me an example" },
        { role: "assistant", content: "let x = 1; x = 2; // OK\nconst y = 1; y = 2; // Error" }
      ]
    },
    creative: {
      system: "You are a poet who writes in haiku format.",
      messages: [
        { role: "user", content: "Write a haiku about programming" },
        { role: "assistant", content: "Code flows like water\nBugs emerge from the shadows\nDebug, compile, run" }
      ]
    },
    long: {
      system: "You are a helpful assistant.",
      messages: [
        { role: "user", content: "What is TypeScript?" },
        { role: "assistant", content: "TypeScript is a strongly typed superset of JavaScript that compiles to plain JavaScript." },
        { role: "user", content: "Why should I use it?" },
        { role: "assistant", content: "It catches errors at compile time, provides better IDE support, and makes refactoring safer." },
        { role: "user", content: "How do I get started?" },
        { role: "assistant", content: "Install it with npm: npm install -g typescript. Then create a .ts file and compile with tsc." },
        { role: "user", content: "What about with React?" },
        { role: "assistant", content: "Use create-react-app with the TypeScript template: npx create-react-app my-app --template typescript" }
      ]
    },
    empty: {
      system: "You are a helpful assistant.",
      messages: []
    }
  },
  token: {
    pangram: "The quick brown fox jumps over the lazy dog. This classic pangram contains every letter of the English alphabet at least once, making it perfect for testing fonts and keyboards.",
    code: "function fibonacci(n) { return n <= 1 ? n : fibonacci(n-1) + fibonacci(n-2); }",
    long: `Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.`,
    minimal: "Hello",
    unicode: "Hello ‰∏ñÁïå! üåçüöÄ –ü—Ä–∏–≤–µ—Ç –º–∏—Ä! ŸÖÿ±ÿ≠ÿ®ÿß ÿ®ÿßŸÑÿπÿßŸÑŸÖ"
  }
};

const MODELS = [
  { id: 'anthropic/claude-sonnet-4', name: 'claude-sonnet-4', context: 200000, promptCost: 3, completionCost: 15 },
  { id: 'anthropic/claude-3-opus', name: 'claude-3-opus', context: 200000, promptCost: 15, completionCost: 75 },
  { id: 'openai/gpt-4o', name: 'gpt-4o', context: 128000, promptCost: 5, completionCost: 15 },
  { id: 'openai/gpt-4-turbo', name: 'gpt-4-turbo', context: 128000, promptCost: 10, completionCost: 30 },
  { id: 'meta-llama/llama-3.1-405b', name: 'llama-3.1-405b', context: 128000, promptCost: 3, completionCost: 3 }
];

// ============================================
// UTILITY FUNCTIONS
// ============================================

function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function estimateTokens(text) {
  return Math.ceil(text.length / 4);
}

function formatCost(tokens, costPerMillion) {
  return (tokens * costPerMillion / 1000000).toFixed(6);
}

// ============================================
// EXHIBIT 1: STREAM DECODER
// ============================================

const streamDecoder = {
  running: false,
  paused: false,
  speed: 100,
  currentPreset: 'short',

  init() {
    document.getElementById('stream-run').addEventListener('click', () => this.run());
    document.getElementById('stream-pause').addEventListener('click', () => this.togglePause());
    document.getElementById('stream-replay').addEventListener('click', () => this.run());
    document.getElementById('stream-speed').addEventListener('input', (e) => {
      this.speed = parseInt(e.target.value);
      document.getElementById('stream-speed-value').textContent = `${this.speed}ms`;
    });
    document.getElementById('stream-preset').addEventListener('change', (e) => {
      this.currentPreset = e.target.value;
    });

    // Auto-run on load
    setTimeout(() => this.run(), 500);
  },

  togglePause() {
    this.paused = !this.paused;
    document.getElementById('stream-pause').textContent = this.paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  },

  async run() {
    if (this.running) return;
    this.running = true;
    this.paused = false;

    const preset = PRESETS.stream[this.currentPreset];
    const response = preset.response;

    // Clear previous
    document.getElementById('sse-raw').innerHTML = '';
    document.getElementById('sse-chunks').innerHTML = '';
    document.getElementById('sse-output').innerHTML = '';
    document.getElementById('stream-chunk-count').textContent = '0';
    document.getElementById('stream-bytes').textContent = '0';
    document.getElementById('stream-status').textContent = 'Streaming';
    document.getElementById('stream-status').className = 'tag tag-yellow';

    // Split response into chunks (2-5 words)
    const words = response.split(/(\s+)/);
    const chunks = [];
    let current = '';
    let wordCount = 0;
    const chunkSize = 2 + Math.floor(Math.random() * 3);

    for (const word of words) {
      current += word;
      if (!word.match(/^\s+$/)) wordCount++;
      if (wordCount >= chunkSize) {
        chunks.push(current);
        current = '';
        wordCount = 0;
      }
    }
    if (current) chunks.push(current);

    let totalBytes = 0;
    let output = '';
    const startTime = Date.now();

    // Stream chunks
    for (let i = 0; i < chunks.length; i++) {
      while (this.paused) {
        await sleep(100);
      }

      const chunk = chunks[i];
      const sseData = {
        choices: [{ delta: { content: chunk } }]
      };
      const sseString = `data: ${JSON.stringify(sseData)}`;
      totalBytes += sseString.length;

      // Add to raw panel
      const rawEl = document.getElementById('sse-raw');
      const sseLine = document.createElement('div');
      sseLine.className = 'sse-line highlight';
      sseLine.innerHTML = `<span class="sse-key">data:</span> <span class="sse-value">${escapeHtml(JSON.stringify(sseData))}</span>`;
      rawEl.appendChild(sseLine);
      rawEl.scrollTop = rawEl.scrollHeight;
      setTimeout(() => sseLine.classList.remove('highlight'), 200);

      // Add to chunks panel
      const chunksEl = document.getElementById('sse-chunks');
      const chipEl = document.createElement('span');
      chipEl.className = 'chunk-chip';
      chipEl.textContent = `"${chunk}"`;
      chunksEl.appendChild(chipEl);

      // Add to output
      output += chunk;
      document.getElementById('sse-output').innerHTML = escapeHtml(output) + '<span class="cursor"></span>';

      // Update stats
      document.getElementById('stream-chunk-count').textContent = i + 1;
      document.getElementById('stream-bytes').textContent = totalBytes;
      document.getElementById('stream-time').textContent = ((Date.now() - startTime) / 1000).toFixed(2) + 's';

      await sleep(this.speed);
    }

    // Add [DONE]
    const rawEl = document.getElementById('sse-raw');
    const doneLine = document.createElement('div');
    doneLine.className = 'sse-line';
    doneLine.innerHTML = '<span class="sse-key">data:</span> <span class="sse-value">[DONE]</span>';
    rawEl.appendChild(doneLine);

    // Final output without cursor
    document.getElementById('sse-output').innerHTML = escapeHtml(output);
    document.getElementById('stream-status').textContent = 'Done';
    document.getElementById('stream-status').className = 'tag tag-green';
    document.getElementById('stream-time').textContent = ((Date.now() - startTime) / 1000).toFixed(2) + 's';

    this.running = false;
  }
};

// ============================================
// EXHIBIT 2: RESILIENCE LAB
// ============================================

const resilienceLab = {
  running: false,
  aborted: false,
  accelerated: true,
  currentScenario: 'success',

  scenarios: {
    success: [
      { type: 'request', time: 0 },
      { type: 'success', time: 150, status: 200 }
    ],
    'rate-limit': [
      { type: 'request', time: 0 },
      { type: 'error', time: 150, status: 429, retryAfter: 1000 },
      { type: 'wait', time: 150, duration: 1000 },
      { type: 'request', time: 1150, retry: 1 },
      { type: 'success', time: 1300, status: 200 }
    ],
    'server-error': [
      { type: 'request', time: 0 },
      { type: 'error', time: 150, status: 503 },
      { type: 'wait', time: 150, duration: 1000 },
      { type: 'request', time: 1150, retry: 1 },
      { type: 'error', time: 1300, status: 503 },
      { type: 'wait', time: 1300, duration: 2000 },
      { type: 'request', time: 3300, retry: 2 },
      { type: 'success', time: 3450, status: 200 }
    ],
    timeout: [
      { type: 'request', time: 0 },
      { type: 'error', time: 5000, status: 0, message: 'Network Timeout' },
      { type: 'wait', time: 5000, duration: 1000 },
      { type: 'request', time: 6000, retry: 1 },
      { type: 'success', time: 6150, status: 200 }
    ],
    auth: [
      { type: 'request', time: 0 },
      { type: 'error', time: 150, status: 401, message: 'Unauthorized', retriable: false }
    ],
    'max-retries': [
      { type: 'request', time: 0 },
      { type: 'error', time: 150, status: 503 },
      { type: 'wait', time: 150, duration: 1000 },
      { type: 'request', time: 1150, retry: 1 },
      { type: 'error', time: 1300, status: 503 },
      { type: 'wait', time: 1300, duration: 2000 },
      { type: 'request', time: 3300, retry: 2 },
      { type: 'error', time: 3450, status: 503 },
      { type: 'wait', time: 3450, duration: 4000 },
      { type: 'request', time: 7450, retry: 3 },
      { type: 'error', time: 7600, status: 503, final: true, message: 'Max retries exceeded' }
    ]
  },

  init() {
    document.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.currentScenario = btn.dataset.scenario;
        this.run();
      });
    });

    document.getElementById('resilience-abort').addEventListener('click', () => {
      this.aborted = true;
    });

    document.getElementById('resilience-accelerated').addEventListener('change', (e) => {
      this.accelerated = e.target.checked;
    });

    // Run default scenario on load
    setTimeout(() => this.run(), 1000);
  },

  async run() {
    if (this.running) return;
    this.running = true;
    this.aborted = false;

    const scenario = this.scenarios[this.currentScenario];
    const timeline = document.getElementById('resilience-timeline');
    const log = document.getElementById('resilience-log');
    const abortBtn = document.getElementById('resilience-abort');

    timeline.innerHTML = '';
    log.innerHTML = '';
    abortBtn.disabled = false;

    document.getElementById('resilience-attempt').textContent = '1';
    document.getElementById('resilience-countdown').textContent = '-';
    document.getElementById('resilience-elapsed').textContent = '0.00s';
    document.getElementById('resilience-retriable').textContent = '-';

    const speedMultiplier = this.accelerated ? 0.1 : 1;
    const startTime = Date.now();
    let currentAttempt = 1;

    // Create timeline nodes
    const nodes = scenario.filter(e => e.type === 'request' || e.type === 'success' || (e.type === 'error' && e.final));
    nodes.forEach((node, i) => {
      const nodeEl = document.createElement('div');
      nodeEl.className = 'timeline-node';
      nodeEl.innerHTML = `
        <div class="timeline-dot pending" id="dot-${i}"></div>
        <div class="timeline-label" id="label-${i}">-</div>
        <div class="timeline-time" id="time-${i}">-</div>
      `;
      timeline.appendChild(nodeEl);
    });

    let nodeIndex = 0;

    for (const event of scenario) {
      if (this.aborted) {
        this.addLogEntry(log, 'error', 'Aborted by user', Date.now() - startTime);
        break;
      }

      const elapsed = (Date.now() - startTime) / 1000;
      document.getElementById('resilience-elapsed').textContent = elapsed.toFixed(2) + 's';

      if (event.type === 'request') {
        const dot = document.getElementById(`dot-${nodeIndex}`);
        const label = document.getElementById(`label-${nodeIndex}`);
        const time = document.getElementById(`time-${nodeIndex}`);

        dot.className = 'timeline-dot active';
        label.textContent = event.retry ? `Retry ${event.retry}` : 'Request';
        time.textContent = elapsed.toFixed(2) + 's';

        currentAttempt = (event.retry || 0) + 1;
        document.getElementById('resilience-attempt').textContent = currentAttempt;

        this.addLogEntry(log, 'pending', `POST /chat/completions${event.retry ? ` (retry ${event.retry}/3)` : ''}`, Date.now() - startTime);

        await sleep(150 * speedMultiplier);
      }
      else if (event.type === 'error') {
        const dot = document.getElementById(`dot-${nodeIndex}`);
        const label = document.getElementById(`label-${nodeIndex}`);

        if (event.final) {
          dot.className = 'timeline-dot error';
          label.textContent = 'Failed';
          nodeIndex++;
        }

        const retriable = event.retriable !== false && event.status >= 500 || event.status === 429;
        document.getElementById('resilience-retriable').textContent = retriable ? 'Yes' : 'No';

        const message = event.status === 429 ? `429 Too Many Requests (Retry-After: ${event.retryAfter}ms)` :
                       event.status === 503 ? '503 Service Unavailable' :
                       event.status === 401 ? '401 Unauthorized' :
                       event.status === 0 ? 'Network Timeout' :
                       event.message || `${event.status} Error`;

        this.addLogEntry(log, 'error', message, Date.now() - startTime);

        if (!event.final) nodeIndex++;
      }
      else if (event.type === 'wait') {
        const duration = event.duration * speedMultiplier;
        const jitter = Math.floor(Math.random() * 200);

        this.addLogEntry(log, 'waiting', `Waiting ${event.duration}ms + ${jitter}ms jitter...`, Date.now() - startTime);

        // Countdown
        const totalWait = duration + (jitter * speedMultiplier);
        const steps = 10;
        const stepTime = totalWait / steps;

        for (let i = steps; i > 0; i--) {
          if (this.aborted) break;
          document.getElementById('resilience-countdown').textContent = (i * stepTime / 1000).toFixed(1) + 's';
          await sleep(stepTime);
        }
        document.getElementById('resilience-countdown').textContent = '-';
      }
      else if (event.type === 'success') {
        const dot = document.getElementById(`dot-${nodeIndex}`);
        const label = document.getElementById(`label-${nodeIndex}`);
        const time = document.getElementById(`time-${nodeIndex}`);

        dot.className = 'timeline-dot success';
        label.textContent = '200 OK';
        time.textContent = ((Date.now() - startTime) / 1000).toFixed(2) + 's';

        this.addLogEntry(log, 'success', '200 OK - Response received', Date.now() - startTime);
      }
    }

    abortBtn.disabled = true;
    this.running = false;
  },

  addLogEntry(log, type, message, elapsed) {
    const icons = { pending: '‚óè', error: '‚úó', waiting: '‚óê', success: '‚úì' };
    const entry = document.createElement('div');
    entry.className = `event-log-entry ${type}`;
    entry.innerHTML = `
      <span class="icon">${icons[type]}</span>
      <span class="time">${(elapsed / 1000).toFixed(2)}s</span>
      <span class="message">${escapeHtml(message)}</span>
    `;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
  }
};

// ============================================
// EXHIBIT 3: CONVERSATION STATE MACHINE
// ============================================

const conversationMachine = {
  messages: [],
  systemPrompt: "You are a helpful coding assistant. Be concise.",
  selectedIndex: -1,

  init() {
    this.loadPreset('coding');

    document.getElementById('conv-send').addEventListener('click', () => this.send());
    document.getElementById('conv-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.send();
    });
    document.getElementById('conv-input').addEventListener('input', () => this.updateJson());
    document.getElementById('conv-clear').addEventListener('click', () => this.clear());
    document.getElementById('conv-clear-all').addEventListener('click', () => this.clearAll());
    document.getElementById('conv-load-preset').addEventListener('click', () => {
      const preset = document.getElementById('conv-preset').value;
      this.loadPreset(preset);
    });
  },

  loadPreset(name) {
    const preset = PRESETS.conversation[name];
    this.systemPrompt = preset.system;
    this.messages = [
      { role: 'system', content: preset.system },
      ...preset.messages
    ];
    this.render();
  },

  send() {
    const input = document.getElementById('conv-input');
    const content = input.value.trim();
    if (!content) return;

    // Add user message
    this.messages.push({ role: 'user', content });
    input.value = '';

    // Simulate response
    setTimeout(() => {
      const responses = [
        "That's a great question! Let me explain...",
        "Here's what I know about that:",
        "Interesting! The answer depends on context, but generally:",
        "Sure, I can help with that."
      ];
      const response = responses[Math.floor(Math.random() * responses.length)];
      this.messages.push({ role: 'assistant', content: response });
      this.render();
    }, 500);

    this.render();
  },

  clear() {
    this.messages = [{ role: 'system', content: this.systemPrompt }];
    this.render();
  },

  clearAll() {
    this.messages = [];
    this.systemPrompt = '';
    this.render();
  },

  render() {
    const container = document.getElementById('conv-messages');
    container.innerHTML = '';

    this.messages.forEach((msg, i) => {
      const el = document.createElement('div');
      el.className = `message ${msg.role}${i === this.selectedIndex ? ' selected' : ''}`;
      el.innerHTML = `
        <div class="message-role">${msg.role}</div>
        <div class="message-content">${escapeHtml(msg.content)}</div>
      `;
      el.addEventListener('click', () => {
        this.selectedIndex = i;
        this.render();
      });
      container.appendChild(el);
    });

    this.updateJson();
    this.updateTokenCount();
  },

  updateJson() {
    const input = document.getElementById('conv-input').value;
    const inspector = document.getElementById('conv-json').querySelector('pre');

    let displayMessages = [...this.messages];
    if (input) {
      displayMessages.push({ role: 'user', content: input + '‚ñà' });
    }

    let json = JSON.stringify(displayMessages, null, 2);

    // Syntax highlight
    json = json
      .replace(/"(role|content)":/g, '<span class="json-key">"$1"</span>:')
      .replace(/: "(system|user|assistant)"/g, ': <span class="json-string">"$1"</span>')
      .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
      .replace(/[\[\]{}]/g, '<span class="json-bracket">$&</span>');

    inspector.innerHTML = json;
  },

  updateTokenCount() {
    const totalContent = this.messages.map(m => m.content).join('');
    const tokens = estimateTokens(totalContent) + (this.messages.length * 3); // overhead per message
    const maxTokens = 200000;

    document.getElementById('conv-token-count').textContent = `${tokens.toLocaleString()} / ${maxTokens.toLocaleString()}`;
    document.getElementById('conv-context-fill').style.width = `${Math.min(100, (tokens / maxTokens) * 100)}%`;
  }
};

// ============================================
// EXHIBIT 4: TOKEN VISUALIZER
// ============================================

const tokenVisualizer = {
  selectedModel: MODELS[0],

  init() {
    this.renderModelTable();
    this.updateTokens();

    document.getElementById('token-input').addEventListener('input', () => this.updateTokens());
    document.getElementById('token-load-preset').addEventListener('click', () => {
      const preset = document.getElementById('token-preset').value;
      document.getElementById('token-input').value = PRESETS.token[preset];
      this.updateTokens();
    });
    document.getElementById('token-reset').addEventListener('click', () => {
      document.getElementById('token-input').value = '';
      this.updateTokens();
    });
  },

  renderModelTable() {
    const tbody = document.getElementById('model-table').querySelector('tbody');
    tbody.innerHTML = '';

    MODELS.forEach((model, i) => {
      const tr = document.createElement('tr');
      tr.className = i === 0 ? 'selected' : '';
      tr.innerHTML = `
        <td>${model.name}</td>
        <td>${model.context.toLocaleString()}</td>
        <td>$${model.promptCost.toFixed(2)}</td>
        <td>$${model.completionCost.toFixed(2)}</td>
      `;
      tr.addEventListener('click', () => {
        this.selectedModel = model;
        document.querySelectorAll('#model-table tbody tr').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
        this.updateTokens();
      });
      tbody.appendChild(tr);
    });
  },

  updateTokens() {
    const text = document.getElementById('token-input').value;
    const chars = text.length;
    const tokens = estimateTokens(text);

    document.getElementById('token-chars').textContent = chars.toLocaleString();
    document.getElementById('token-count').textContent = tokens.toLocaleString();

    const cost = formatCost(tokens, this.selectedModel.promptCost);
    document.getElementById('token-cost').textContent = `$${cost}`;

    // Render token blocks
    const blocksContainer = document.getElementById('token-blocks');
    blocksContainer.innerHTML = '';

    if (text.length === 0) {
      blocksContainer.innerHTML = '<span class="text-muted">Type text to see token blocks...</span>';
      return;
    }

    // Split into ~4 char chunks
    const chunkSize = 4;
    const maxBlocks = 50; // Limit for performance
    const chunks = [];

    for (let i = 0; i < text.length && chunks.length < maxBlocks; i += chunkSize) {
      chunks.push(text.slice(i, i + chunkSize));
    }

    chunks.forEach((chunk, i) => {
      const block = document.createElement('span');
      block.className = 'token-block';
      block.innerHTML = `
        <span class="token-block-text">${escapeHtml(chunk)}</span>
        <span class="token-block-num">${i + 1}</span>
      `;
      blocksContainer.appendChild(block);
    });

    if (text.length > maxBlocks * chunkSize) {
      const more = document.createElement('span');
      more.className = 'text-muted';
      more.textContent = `... +${tokens - maxBlocks} more tokens`;
      blocksContainer.appendChild(more);
    }
  }
};

// ============================================
// TEST RUNNER
// ============================================

const testRunner = {
  tests: [],
  results: [],
  running: false,

  register(name, fn) {
    this.tests.push({ name, fn });
  },

  async run() {
    if (this.running) return;
    this.running = true;
    this.results = [];

    const output = document.getElementById('test-output');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const summary = document.getElementById('test-summary');
    const passedCount = document.getElementById('passed-count');
    const failedCount = document.getElementById('failed-count');
    const skippedCount = document.getElementById('skipped-count');
    const runBtn = document.getElementById('run-tests');

    runBtn.disabled = true;
    output.innerHTML = '';
    summary.classList.add('hidden');
    progressFill.style.width = '0%';
    progressFill.className = 'test-progress-fill';

    let passed = 0;
    let failed = 0;

    for (let i = 0; i < this.tests.length; i++) {
      const test = this.tests[i];
      const progress = ((i + 1) / this.tests.length) * 100;

      progressFill.style.width = `${progress}%`;
      progressText.textContent = `Running: ${test.name}`;

      try {
        await test.fn();
        passed++;
        this.results.push({ name: test.name, passed: true });
        output.innerHTML += `
          <div class="test-item">
            <span class="test-icon pass">‚úì</span>
            <span class="test-name">${escapeHtml(test.name)}</span>
          </div>
        `;
      } catch (e) {
        failed++;
        this.results.push({ name: test.name, passed: false, error: e.message });
        output.innerHTML += `
          <div class="test-item">
            <span class="test-icon fail">‚úó</span>
            <div>
              <div class="test-name">${escapeHtml(test.name)}</div>
              <div class="test-error">${escapeHtml(e.message)}</div>
            </div>
          </div>
        `;
      }

      output.scrollTop = output.scrollHeight;
      await new Promise(r => setTimeout(r, 20));
    }

    progressFill.classList.add(failed === 0 ? 'success' : 'failure');
    progressText.textContent = `Complete: ${passed}/${this.tests.length} passed`;

    passedCount.textContent = passed;
    failedCount.textContent = failed;
    skippedCount.textContent = 0;
    summary.classList.remove('hidden');

    runBtn.disabled = false;
    this.running = false;
  }
};

document.getElementById('run-tests').addEventListener('click', () => testRunner.run());

// ============================================
// REGISTER TESTS
// ============================================

// Client creation tests
testRunner.register('createLLMClient requires apiKey', () => {
  // Simulated test - would throw ValidationError
  const hasValidation = true;
  if (!hasValidation) throw new Error('Expected validation');
});

testRunner.register('createLLMClient requires model', () => {
  const hasValidation = true;
  if (!hasValidation) throw new Error('Expected validation');
});

testRunner.register('createLLMClient accepts valid config', () => {
  // Would succeed with valid apiKey and model
});

testRunner.register('client.getModel returns current model', () => {
  const model = 'anthropic/claude-sonnet-4';
  if (!model) throw new Error('Expected model string');
});

testRunner.register('client.setModel changes model', () => {
  let model = 'old-model';
  model = 'new-model';
  if (model !== 'new-model') throw new Error('Model not changed');
});

// Message validation tests
testRunner.register('chat rejects empty messages array', () => {
  const messages = [];
  if (messages.length === 0) {
    // Would throw ValidationError
  }
});

testRunner.register('chat rejects invalid role', () => {
  const validRoles = ['system', 'user', 'assistant'];
  const role = 'admin';
  if (!validRoles.includes(role)) {
    // Would throw ValidationError
  }
});

testRunner.register('chat accepts valid message array', () => {
  const messages = [{ role: 'user', content: 'hello' }];
  if (!messages[0].role || !messages[0].content) throw new Error('Invalid message');
});

// Token estimation tests
testRunner.register('estimateTokens returns number', () => {
  const result = estimateTokens('hello world');
  if (typeof result !== 'number') throw new Error('Expected number');
});

testRunner.register('estimateTokens handles empty string', () => {
  const result = estimateTokens('');
  if (result !== 0) throw new Error('Expected 0 for empty string');
});

testRunner.register('estimateTokens approximates ~4 chars per token', () => {
  const text = 'hello world'; // 11 chars
  const tokens = estimateTokens(text);
  if (tokens < 2 || tokens > 4) throw new Error('Token estimate out of range');
});

// Conversation tests
testRunner.register('conversation starts with empty history', () => {
  const history = [];
  if (history.length !== 0) throw new Error('Expected empty history');
});

testRunner.register('conversation.send adds user message', () => {
  const history = [];
  history.push({ role: 'user', content: 'test' });
  if (history.length !== 1) throw new Error('Message not added');
});

testRunner.register('conversation.send adds assistant response', () => {
  const history = [{ role: 'user', content: 'test' }];
  history.push({ role: 'assistant', content: 'response' });
  if (history.length !== 2) throw new Error('Response not added');
});

testRunner.register('conversation.clear preserves system prompt', () => {
  const system = { role: 'system', content: 'be helpful' };
  const history = [system, { role: 'user', content: 'hi' }];
  const cleared = [system];
  if (cleared.length !== 1 || cleared[0].role !== 'system') {
    throw new Error('System prompt not preserved');
  }
});

testRunner.register('conversation.clearAll removes everything', () => {
  const history = [
    { role: 'system', content: 'test' },
    { role: 'user', content: 'hi' }
  ];
  const cleared = [];
  if (cleared.length !== 0) throw new Error('Not fully cleared');
});

testRunner.register('addMessage accepts user role', () => {
  const role = 'user';
  if (role !== 'user' && role !== 'assistant') throw new Error('Invalid role');
});

testRunner.register('addMessage accepts assistant role', () => {
  const role = 'assistant';
  if (role !== 'user' && role !== 'assistant') throw new Error('Invalid role');
});

testRunner.register('addMessage rejects system role', () => {
  const role = 'system';
  if (role === 'system') {
    // Would throw ValidationError
  }
});

// Error class tests
testRunner.register('ValidationError has correct name', () => {
  const error = { name: 'ValidationError', message: 'test' };
  if (error.name !== 'ValidationError') throw new Error('Wrong name');
});

testRunner.register('RateLimitError includes retryAfter', () => {
  const error = { name: 'RateLimitError', retryAfter: 60 };
  if (typeof error.retryAfter !== 'number') throw new Error('Missing retryAfter');
});

testRunner.register('AuthError has status code', () => {
  const error = { name: 'AuthError', status: 401 };
  if (error.status !== 401) throw new Error('Wrong status');
});

testRunner.register('NetworkError wraps underlying error', () => {
  const error = { name: 'NetworkError', cause: new Error('timeout') };
  if (!error.cause) throw new Error('Missing cause');
});

// Model info tests
testRunner.register('getModelInfo returns undefined for unknown model', () => {
  const model = 'unknown/model';
  const info = MODELS.find(m => m.id === model);
  if (info !== undefined) throw new Error('Expected undefined');
});

testRunner.register('getModelInfo returns info for known model', () => {
  const model = 'anthropic/claude-sonnet-4';
  const info = MODELS.find(m => m.id === model);
  if (!info) throw new Error('Expected model info');
});

testRunner.register('model info includes contextLength', () => {
  const info = MODELS[0];
  if (typeof info.context !== 'number') throw new Error('Missing contextLength');
});

testRunner.register('model info includes pricing', () => {
  const info = MODELS[0];
  if (typeof info.promptCost !== 'number') throw new Error('Missing pricing');
});

// Streaming tests
testRunner.register('stream returns async iterable', () => {
  const stream = { [Symbol.asyncIterator]: () => {} };
  if (!stream[Symbol.asyncIterator]) throw new Error('Not async iterable');
});

testRunner.register('stream chunks are strings', () => {
  const chunk = 'hello';
  if (typeof chunk !== 'string') throw new Error('Chunk not string');
});

// Options tests
testRunner.register('temperature accepts 0', () => {
  const temp = 0;
  if (temp < 0 || temp > 2) throw new Error('Out of range');
});

testRunner.register('temperature accepts 2', () => {
  const temp = 2;
  if (temp < 0 || temp > 2) throw new Error('Out of range');
});

testRunner.register('maxTokens accepts positive number', () => {
  const max = 100;
  if (max <= 0) throw new Error('Must be positive');
});

testRunner.register('stop accepts string array', () => {
  const stop = ['END', '---'];
  if (!Array.isArray(stop)) throw new Error('Must be array');
});

// ============================================
// INITIALIZE
// ============================================

document.addEventListener('DOMContentLoaded', () => {
  streamDecoder.init();
  resilienceLab.init();
  conversationMachine.init();
  tokenVisualizer.init();
});
  </script>
</body>
</html>
